<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Subir imagen a Firebase</title>
</head>
<body>
  <h2>Selecciona una imagen para tu producto</h2>
  <input type="file" id="fileInput" accept="image/*"><br><br>
  <button onclick="subirImagen()">Subir a ImgBB</button>
  <p id="resultado"></p>

  <script>
    function obtenerCorreoDesdeURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("correo");
    }

    function subirImagen() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        alert("Selecciona una imagen primero.");
        return;
      }

      const reader = new FileReader();
      reader.onloadend = function () {
        const base64 = reader.result.split(',')[1];
        const formData = new FormData();
        formData.append("image", base64);

        fetch("https://api.imgbb.com/1/upload?key=61c6607d8942db70af0966b6b674ce78", {
          method: "POST",
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          const urlImg = data.data.url;
          const correo = obtenerCorreoDesdeURL();
          if (!correo) {
            alert("No se proporcionó el correo.");
            return;
          }

          const clave = correo.replace(/[@.]/g, "_");
          const fotoObj = { "foto": urlImg };

          fetch("https://etiangue-default-rtdb.firebaseio.com/vendedor/" + clave + ".json", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(fotoObj)
          }).then(() => {
            document.getElementById("resultado").innerHTML = `
              <strong>✅ Imagen subida y guardada en Firebase</strong><br>
              <a href="${urlImg}" target="_blank">${urlImg}</a>
            `;
          });
        })
        .catch(error => {
          document.getElementById("resultado").innerText = "Error: " + error;
        });
      };

      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
